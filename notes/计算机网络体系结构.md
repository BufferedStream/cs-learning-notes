## 计算机网络体系结构

在网络核心部分起特殊作用的是路由器（router），它是一种专用计算机。路由器是实现分组交换（packet switching）的关键构件，其任务是转发收到的分组，这是网络核心部分最重要的功能。

#### 电路交换

从通信资源的分配角度来看，交换（switching）就是按照某种方式动态地分配传输线路的资源。必须经过 “建立连接（占用通信资源）> 通话（一直占用通信资源） > 释放连接（归还通信资源）“ 三个步骤的交换方式称为电路交换。电话系统一直使用电路交换，在通话的全部时间内，通话的两个用户始终占用端到端的通信资源。

当使用电路交换来传送计算机数据时，其线路的传输效率往往很低。这是因为计算机数据时突发式地出现在传输线路上地，因此线路上真正用来传送数据的时间往往不到 10% 甚至 1%。已被用户占用的通信线路资源在绝大部分时间里都是空闲的。



#### 分组交换

分组交换则采用**存储转发**技术。图 1-10 画的是把一个报文划分为几个分组的概念。通常我们把要发送的整块数据称为一个**报文**（message）。在发送报文之前，先把较长的报文划分成为一个个更小的等长数据段，例如每个数据段为 1024 bit。在每一个数据段前面，加上一些必要的控制信息组成的**首部**（header）后，就构成了一个**分组**（packet）。分组又称为 ”**包**“，而分组的首部也可称为 ”**包头**“。分组是在因特网中传送的数据单元。分组中的 ”首部“ 是非常重要的，正是由于分组的首部包含了诸如目的地址和源地址等重要控制信息，每一个分组才能在因特网中独立地选择传输路径，并被正确地交付到分组传输的终点。

<div align="center"> <img src="https://raw.githubusercontent.com/BufferedStream/cs-learning-notes/master/notes/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%9B%BE1.png"/> </div><br>
位于网络边缘的主机和位于网络核心部分的路由器都是计算机，但它们的作用却很不一样。**主机是为用户进行信息处理的**，并且可以和其他主机通过网络交换信息，**路由器则是用来转发分组的，即进行分组交换的**。路由器收到一个分组，先暂时存储一下，检查其首部，查找转发表，按照首部中的目的地址，找到合适的接口转发出去，把分组交给下一个路由器。这样一步一步地（有时会经过几十个不同的路由器）以存储转发地方式，把分组交付最终的目的主机。各路由器之间必须经常交换彼此掌握的路由信息，以便创建和维持在路由器中的转发表，使得转发表能够在整个网络拓扑发生变化时及时更新。

因为分组交换的特点，一条传输线路可以同时传输多个分组。发送出的报文拆分成多个分组，在传输过程中各个分组通过最佳路径（路由算法）路由到目标，目的计算机把收到的所有分组按照适当的顺序重新排列，就能合并恢复出原来的内容。

路由器暂时存储的是一个个短分组，而不是整个的长报文。短分组是暂存在路由器的存储器（即内存）而不是存储在磁盘中的。这就保证了较高的交换速率。

分组交换的优点：

| 优点 | 所采用的手段                                                 |
| ---- | ------------------------------------------------------------ |
| 高效 | 在分组传输的过程中动态分配传输带宽，对通信链路是逐段占用     |
| 灵活 | 为每一个分组独立地选择最合适的转发路由                       |
| 迅速 | 以分组作为传送单位，可以不先建立连接就能向其他主机发送分组   |
| 可靠 | 保证可靠性地网络协议；分布式多路由的分组交换网，使网络有很好的生存性 |

分组交换的缺点：

分组交换也带来一些新的问题。例如，分组在各路由器存储转发时需要排队，这就会造成一定的时延。因此，必须尽量设法减少这种时延。此外，由于分组交换不像电路交换那样通过建立连接来保证通信时所需的各种资源，因而无法确保通信时端到端所需的贷款。

分组交换带来的另一个问题是各分组必须携带的控制信息也造成了一定的开销（overhead）。整个分组交换网还需要专门的管理和控制机制。

从本质上讲，这种断续分配传输带宽的存储转发原理并非是完全新的概念。自古代就有的邮政通信，就其本质来说也是属于存储转发方式。而在20世纪40年代，电报通信也采用了基于储存转发原理的报文交换。分组交换虽然也采用存储转发原理，但由于使用了计算机进行处理，这就使分组的转发非常迅速。这样，分组交换虽然采用了某些古老的交换原理，但实际上已经变成了一种崭新的交换技术。



#### TCP/IP

OSI 的七层协议体系结构（图 1-18(a)）的概念清楚，理论也比较完整，但它既复杂又不实用。TCP/IP 体系结构则不同，它现在已经得到了非常广泛的应用。TCP/IP 是一个四层的体系结构（图 1-18(b)），它包含应用层、运输层、网际层和网络接口层（用网际层这个名字是强调这一层是为了解决不同网络的互联问题）。不过从实质上讲，TCP/IP 只有最上面的三层，因为最下面的网络接口层并没有什么具体内容。因此在学习计算机网络的原理时往往采取这种折中的办法，即综合 OSI 和 TCP/IP 的优点，采用一种只有五层协议的体系结构（图 1-18(c)），这样即简洁又能将概念阐述清楚。有时为了方便，也可把最底下两层称为网络接口层。（五层协议的体系结构只是为介绍网络原理而设计的，实际应用还是 TCP/IP 四层体系结构）。

<div align="center"> <img src="https://raw.githubusercontent.com/BufferedStream/cs-learning-notes/master/notes/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%9B%BE2.png"/> </div><br>
1. **应用层**（application layer）

   应用层是体系结构中的最高层。应用层的任务是**通过应用进程间的交互来完成特定网络应用**。应用层协议定义的是**应用进程间通信和交互的规则**。这里的**进程**就是指主机中**正在运行的程序**。对于不同的网络应用需要有不同的应用层协议。在互联网中的应用层协议很多，如域名系统 DNS，支持万维网应用的 HTTP 协议，支持电子邮件的 SMTP 协议，等等。我们把应用层交互的数据单元称为**报文**（message）。

2. **运输层**（transport layer）

   运输层的任务就是负责向**两条主机中进程之间的通信**提供**通用的数据传输**服务。应用进程利用该服务传送应用层报文。所谓 “通用的”，是指并不针对某个特定网络应用，而是多种应用可以使用同一个运输层服务。由于一台主机可同时运行多个进程，因此运输层有复用和分用的功能。复用就是多个应用层可同时使用下面运输层的服务，分用和复用相反，是运输层把收到的信息分别交付上面应用层中的相应进程。

   运输层主要使用以下两种协议：

   - **传输控制协议** TCP（Transmission Control Protocol）—— 提供面向连接的、可靠的数据传输服务，其数据传输的单位是**报文段**（segment）。
   - **用户数据报协议** UDP（User Dategram Protocol）—— 提供无连接的、**尽最大努力**（best-effort）的数据传输服务（不保证数据传输的可靠性），其数据传输的单位是**用户数据报**。

   顺便指出，有人愿意把运输层称为传输层，理由是这一层使用的 TCP 协议就叫做传输控制协议。从意思上看，传输和运输差别也不大。但 OSI 定义的第 4 层使用的是 Transport，而不是 Treansmission。这两个字的含义还是有些差别。因此，使用运输层这个译名较为准确。

3. **网络层**（network layer）

   网络层负责为分组交换网上的不同**主机**提供通信服务。在发送数据时，网络层把运输层产生的报文段或用户数据报封装成**分组**或**包**进行传送。在 TCP/IP 体系中，由于网络层使用 IP 协议，因此分组也叫做 **IP 数据报**，或简称为**数据报**。在此**我们把 “分组” 和 “数据报” 作为同义词使用**。

   请注意：不要将运输层的 “用户数据报 UDP” 和网络层的 “IP 数据报” 弄混。此外，**无论在哪一层传送的数据单元，都可笼统地用 “分组” 来表示**。

   网络层的另一个任务就是要选择合适的路由，使源主机运输层所传下来的分组，能够通过网络中的路由器找到目的主机。

   互联网是由大量的**异构**（heterogeneous）网络通过**路由器**（router）相互连接起来的的。互联网使用的网络层协议是无连接的**网际协议** IP（Internet Protocol）和许多种路由选择协议，因此互联网的网络层也叫做**网际层**或 **IP 层**。在此我们把网络层、网际层和 IP 层当同义语使用。

4. **数据链路层**（data link layer）

   数据链路层常简称为**链路层**。我们知道，两台主机之间的数据传输，总是在一段一段的链路上传送的，这就需要使用专门的链路层协议。在两个相邻节点之间传送数据时，数据链路层将网络层交下来的 IP 数据报**组装成帧**（framing），在两个相邻结点间的链路上传送**帧**（frame）。每一帧包括数据和必要的**控制信息**（如同步信息、地址信息、差错控制等）。

   在接收数据时，控制信息使接收端能够知道一个帧从哪个比特开始和到哪个比特结束。这样，数据链路层在收到一个帧后，就可从中提取出数据部分，上交给网络层。

   控制信息还使接收到能够检测到所收到的帧中有无差错。如发现有差错，数据链路层就简单地**丢弃**这个出了差错的帧，一面继续在网络中传送下去白白浪费网络资源。如果需要改正数据在数据链路层传输时出现的差错（这就是说，数据链路层不仅要检错，而且要纠错），那么就要采用可靠传输协议来纠正出现的差错。这种方法会使数据链路层的协议复杂些。

5. **物理层**（physical layer）

   在物理层上所传数据的单位时比特。发送方发送 1（或 0）时，接收方应当受到 1（或0）而不是 0（或 1）。因此物理层要考虑用多大的电压代表 “1” 或 “0”，以及接收方如何识别出发送方送发送的比特。物理层还要确定连接电缆的插头应当有多少根引脚以及各引脚应如何连接。当然，解释比特代表的意思，就不是物理层的任务。请注意，传递信息所利用的一些物理媒体，如双绞线、同轴电缆、光缆、无线信道等，并不在物理层协议之内而是在物理层协议的下面。因此也有人把物理层下面的物理媒体当作第 0 层。

   

在互联网所使用的各种协议中，最重要的和最著名的就是 TCP 和 IP 两个协议。现在人们经常提到的 TCP/IP 并不一定时单指 TCP 和 IP 这两个具体的协议，而往往是表示互联网所使用的整个 TCP/IP 协议族（protocol suite）。

<div align="center"> <img src="https://raw.githubusercontent.com/BufferedStream/cs-learning-notes/master/notes/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%9B%BE3.jpg"/> </div><br>
在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也就不需要传输层和应用层。

TCP/IP 协议族的特点是上下两头大而中间小：应用层和网络接口层都有各种协议，而中间的 IP 层很小，上层的各种协议都向下汇聚到一个 IP 协议中。这种很像沙漏计时器形状的 TCP/IP 协议**可以为各式各样的应用提供服务**（所谓的 everything over IP），同时 TCP/IP 协议也**允许 IP 协议在各式各样的网络构成的互联网上运行**（所谓的 IP over everything）。正因为如此，互联网才会发展到今天的这种全球规模。从图 1-24 不难看出 IP 协议在互联网中的核心作用。

<div align="center"> <img src="https://raw.githubusercontent.com/BufferedStream/cs-learning-notes/master/notes/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%9B%BE4.jpg"/> </div><br>