## 网络层

#### 概述

**网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务**。这里的数据报（datagram）就是 “分组”。

网络在发送分组时不需要先建立连接。每一个分组独立发送，与其前后的分组无关（不进行编号）。**网络层不提供服务质量的承诺**。也就是说，所传送的分组可能出错、丢失、重复和失序（即不按序到达终点），当然也不保证分组交付的时限。由于传输网络不提供端到端的可靠传输服务，这就使网络中的路由器比较简单，且价格低廉（与电信网的交换机相比较）。如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责（包括差错处理、流量控制等）。



#### 网际协议 IP

与 IP 协议配套使用的还有三个协议：

- **地址解析协议 ARP**（Address Resolution Protocol）
- **网际控制报文协议 ICMP**（Internet Control Message Protocol）
- **网际组管理协议 IGMP**（Internet Group Management Protocol）

图 4-2 画出了这三个协议和网际协议 IP 的关系。在这一层中，ARP 画在最下面，因为 IP 经常要使用这个协议。ICMP 和 IGMP 画在这一层的上部，因为它们要使用 IP 协议。由于网际协议 IP 是用来使互接起来的许多计算机网络能够进行通信的，因此 TCP/IP 体系中的网络层常常被称为**网际层**（internet layer），或 IP 层。使用 “网际层” 这个名称的好处是强调这是由很多网络构成的互连网络。 

<div align="center"> <img src="https://raw.githubusercontent.com/BufferedStream/cs-learning-notes/master/notes/images/%E7%BD%91%E7%BB%9C%E5%B1%82%20-%20%E5%9B%BE1.jpg"/> </div><br>
#### 分类的 IP 地址

##### 1.IP 地址及其表示方法

整个的互联网就是一个**单一的、抽象的网络**。IP 地址就是给互联网上的每一台主机（或路由器）的每一个接口分配一个在全世界范围内是唯一的 32 位的标识符。IP 地址的结构使我们可以在互联网上很方便地进行寻址。

IP 地址的编址方法共经过了三个历史阶段。

（1）**分类的 IP 地址**。这是最基本的编址方法。

（2）**子网的划分**。这是对最基本的编址方法的改进。

（3）**构成超网**。这是比较新的无分类编址方法。

所谓 “分类的 IP 地址” 就是将 IP 地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，其中第一个字段是**网络号**（net-id），它标志主机（或路由器）所连接到的网络。一个网络号在整个互联网范围内必须是唯一的。第二个字段是主机号（host-id），它标志该主机（或路由器）。一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。由此可见，一个 IP 地址**在整个互联网范围内是唯一的**。

这种两级的 IP 地址可以记为：

IP 地址 ::={<网络号>,<主机号>}



图 4-5 给出了各种 IP 地址的网络号字段和主机号字段，这里 A 类、 B 类和 C 类地址都是**单播地址**（一对一通信），是最常用的。

<div align="center"> <img src="https://raw.githubusercontent.com/BufferedStream/cs-learning-notes/master/notes/images/%E7%BD%91%E7%BB%9C%E5%B1%82%20-%20%E5%9B%BE2.png"/> </div><br>
从图 4-5 可以看出：

- A 类、 B 类和 C 类地址的网络号字段（在途中这个字段是灰色的）分别为 1 个、 2 个和 3 个字节长，而在网络号字段的最前面有 1~3 位的类别位，其数指分别规定为 0， 10 和 110。
- A 类、 B 类和 C 类地址的主机号字段分别为 3 个、 2 个和 1 个字节长。
- D 类地址（前 4 位是 1110）用于多播（一对多通信）。
- E 类地址（前 4 位是 1111）保留为以后用。	

这里要指出，由于近年来已经广泛使用无分类 IP 地址进行路由选择，A 类、 B 类和 C 类地址的区分已成为历史。为了理解概念的演进

从 IP 地址的结构来看，IP 地址并不仅仅指明一台主机，而是还指明了主机所连接到的网络。

把 IP 地址划分为 A 类、 B 类和 C 类三个类别，当初是这样考虑的。各种网络的差异很大，有的网络拥有很多主机，而有的网络上的主机则很少。把 IP 地址划分为 A 类、 B 类和 C 类是为了更好地满足不同用户的要求。当某个单位申请到一个 IP 地址时，实际上是获得了具有同样网络号的一块地址。其中具体的各台主机号则由该单位自行分配，只要做到在该单位管辖的范围内无重复的主机号即可。

对主机或路由器来说，IP 地址都是 32 位的二进制代码。为了提高可读性，我们常常把 32 位的 IP 地址中的每 8 位插入一个空格（**但在机器中并没有这样的空格**）。为了便于书写，可用其等效的十进制数字表示，并且在这些数字之间加上一个点。这就叫做**点分十进制记法**（dotted decimal notation）。图 4-6 是一个 B 类 IP 地址的表示方法。显然，128.11.3.31 比 10000000 00001011 00000011 00011111 书写起来要方便得多。

<div align="center"> <img src="https://raw.githubusercontent.com/BufferedStream/cs-learning-notes/master/notes/images/%E7%BD%91%E7%BB%9C%E5%B1%82%20-%20%E5%9B%BE3.jpg"/> </div><br>
##### 2.常用的三种类别的 IP 地址

A 类地址的网络号字段占 1 个字节，只有 7 位可供使用（该字段的第一位已固定为 0），但可指派的网络号是 126 个（即 2^32^ - 2）。减 2 的原因是：第一，IP 地址中的全 0 表示 “**这个**（this）”。网络号字段为全 0 的 IP 地址是个保留地址，意思是 “本网络”；第二，网络号为 127（即 01111111）保留作为本地软件**环回测试**（loopback test）本主机的进程之间的通信之用。若主机发送一个目的地址为环回地址（例如 127.0.0.1）的 IP 数据报，则本主机中的协议软件就处理数据报中的数据，而不会把数据报发送到任何网络。目的地址为环回地址的 IP 数据报永远不会出现在任何网络上，因为网络号为 127 的地址根本不是一个网络地址。

关于全 1 和全 0 还可以再举两个例子。例如，B 类地址 128.7.255.255 表示 “在网络 128.7.0.0 上的所有主机”。而 A 类地址 0.0.0.35 则表示 ”在这个网络上主机号为 35 的主机“。

A 类地址的主机号占 3 个字节，因此每一个 A 类网络中的最大主机数是 2^24^ - 2，即 16777214。这里减 2 的原因是：全 0 的主机号字段表示该 IP 地址是 “本主机” 所连接到的**单个网络地址**（例如，一主机的 IP 地址为 5.6.7.8，则该主机所在的网络地址就是 5.0.0.0），而全 1 表示 “**所有的**（all）”，因此全 1 的主机号字段表示该网络上的所有主机。

如果主机号全 0，IP 地址代表仅网络号指向的那个网段，该 IP 代表一个网段；如果主机号全 1，IP 地址代表网络号指向的全部主机，IP 地址代表广播地址 ；其他就是普通的 IP 地址，指向网域中的一个主机了。

在 A 类、B 类、C 类 IP 地址中，如果主机号是全 1，那么这个地址为直接广播地址，它是用来使路由器将一个分组以广播形式发送给特定网络上的所有主机。32 位全为 1 的 **IP地址 ** “255.255.255.255” 为**受限广播地址**（"limited broadcast" destination address），用来将一个分组以广播方式发送给本网络中的所有主机，路由器则阻挡该分组通过，将其广播功能限制在本网内部。

IP 地址空间共有 2^32^（即 4294967296）个地址。整个 A 类地址空间共有 2^31 个地址，占整个 IP 地址空间的 50%。

B 类地址的网络号字段有 2 个字节，但前面两位（1 0）已经固定了，只剩下 14 位可以进行分配。因为网络号字段后面的 14 位无论怎样取值也不可能出现使整个 2 字节的网络号字段成为全 0 或全 1，因此这里不存在网络总数减 2 的问题。但实际上 B 类网络地址 128.0.0.0 是不指派的，而可以指派的 B 类最小网络地址是 128.1.0.0[COME06]。因此 B 类地址可指派的网络数为 2^14^ - 1，即 16383。B 类地址的每一个网络上的最大主机数是 2^16^ - 2，即 65534。这里需要减 2 是因为要扣除全 0 和全 1 的主机号。整个 B 类地址空间共约有 2^30^ 个地址，占整个 IP 地址空间的 25%。

C 类地址有 3 个字节的网络号字段，最前面的 3 位是（1 1 0），还有 21 位可以进行分配。C 类网络地址 192.0.0.0 也是不指派的，可以指派的 C 类最小网络是 192.0.1.0[COME06]，因此 C 类地址可指派的网络总数是 2^21^ - 1，即 2097151。每一个 C 类地址的最大主机是 2^8^ - 2，即 254。整个 C 类地址空间共约有 2^29^ 个地址，占整个 IP 地址的 12.5%。

这样，我们就可得出表 4-2 所示的 IP 地址的指派范围。

<div align="center"> <img src="https://raw.githubusercontent.com/BufferedStream/cs-learning-notes/master/notes/images/%E7%BD%91%E7%BB%9C%E5%B1%82%20-%20%E5%9B%BE4.jpg"/> </div><br>
IP 地址具有以下一些重要特点。

（1）每一个 IP 地址都由网络号和主机号两部分组成。从这个意义上说，IP 地址是一种**分等级的地址结构**。分两个等级的好处是：第一，IP 地址管理机构在分配 IP 地址时**只分配网络号**（第一级），而剩下的主机号（第二级）则由得到该网络号的单位来自行分配。这样就方便了 IP 地址的管理；第二，路由器**仅根据目的主机所连接的网络号来转发分组**（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度较少，从而**减小了路由表所占的存储空间以及查找路由表的时间**。

（2）实际上 IP 地址是标志一台主机（或路由器）和一条链路的**接口**。当一台主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号必须是不同的。这种主机称为**多归属主机**（multihomed host）。由于一个路由器至少应当连接到两个网络，因此一个路由器至少应当有两个不同的 IP 地址。这好比一个建筑正好处在北京路和上海路的交叉口上，那么这个建筑就可以拥有两个门牌号码。例如，北京路 4 号和上海路 37 号。

（3）按照互联网的观点，一个网络是指具有相同网络号 net-id 的主机的集合，因此，**用转发器或网桥连接起来的若干个局域网仍为一个网络**，因为这些局域网都具有同样的网络号。具有不同网络号的局域网必须使用路由器进行互连。

（4）在 IP 地址中，所有分配到网络号的网络（不管是范围很小的局域网，还是可能覆盖很大地理范围的广域网）都是**平等**的。所谓平等，是指互联网同等对待每一个 IP 地址。



#### IP 地址与硬件地址

从层次的角度看，**物理地址是数据链路层和物理层使用的地址**，而 **IP 地址是网络层和以上各层使用的地址，是一种逻辑地址**（称 IP 地址为逻辑地址是因为 IP 地址是用软件实现的）。



在发送数据时，数据从高层下到低层，然后才到通信链路上传输。使用 IP 地址的 IP 数据报一旦交给了数据链路层，就被封装成 MAC 帧了。MAC 帧在传送时使用的源地址和目的地址都是硬件地址，这两个硬件地址都写在 MAC 帧的首部中。



